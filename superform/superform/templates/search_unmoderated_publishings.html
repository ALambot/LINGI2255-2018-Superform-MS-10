<form class="form-group">
     <label for="subject-search"><b>Search by subject :</b></label>
     <input type="text" class="form-control" id="subject-search" placeholder="...">
</form>
<div class="input-group-btn">
      <button type="button" class="btn btn-success" data-toggle="collapse" data-target="#advanced" aria-expanded="true">Advanced search &gt;&gt;</button>
</div>
<div id ="advanced" class="collapse">
<form class="form-group" action="search">
     <label for="body-search"><b> Text contains in body : </b></label>
     <input type="text" class="form-control" id="body-search" placeholder="...">
</form>
<form class="form-group">
     <label for="author-search"><b> Author : </b></label>
     <input type="text" class="form-control" id="author-search" placeholder="...">
</form>
<div class="form-group">
     <label for="channel-search"><b>Channels : </b></label>
                             {% if channels|length == 0 %}
                                 <p>No channel available for this user</p>
                             {% else %}
                                 {% for chan in channels %}
                                     <div class="form-check">
                                      <label class="form-check-label">
                                        <input id ="checkbox-search {{chan.name}}" type="checkbox" class="form-check-input checkbox" checked>{{ chan.name }}
                                      </label>
                                    </div>
                                 {% endfor %}
                             {% endif %}
</div>
</div>
<br/>

<script>
     var allChannels = {% if channels|length == 0 %}[]{% else %}[{% for chan in channels %}'{{chan.name}}',{% endfor %}]{% endif %}
     var nbRequestSearch = 0;
     var filter = {
          channels : allChannels,
          subject : "",
          body : "",
          author : ""
     };

     function waitJQuery(func, args) {
    if (window.jQuery)
         func(args);
    else
        setTimeout(function() {
            waitJQuery(func, args)
        }, 40);
     }

     function launchListener() {
          $("#subject-search" ).on('input', function() {
               filter.subject = $(this).val();
               nbRequestSearch += 1;

          });
          $( "#body-search" ).on('input', function() {
               filter.body = $(this).val();
               nbRequestSearch += 1;
          });

           $( "#author-search" ).on('input', function() {
               filter.author = $(this).val();
               nbRequestSearch += 1;
          });

         $('input.checkbox').change(function () {
            tbId = $(this).attr("id").split(' ');
            checked = $(this).is(":checked")
            if (tbId[0] == "checkbox-search") {
                if (checked && !isInArray(filter.channels, tbId[1])) {
                    filter.channels.push(tbId[1]);
                    nbRequestSearch += 1;
                }
                else if (!checked && isInArray(filter.channels, tbId[1])){
                    filter.channels = removeFromArray(filter.channels, tbId[1]);
                    nbRequestSearch += 1;
                }
            }
        });
     }
     
     function launchSearch(){
        if (nbRequestSearch > 1) {
            nbRequestSearch -= 1;
        }
        else if (nbRequestSearch == 1) {
            nbRequestSearch -= 1
            search();
         }
         if (nbRequestSearch > 10) {
            nbRequestSearch = 0;
            search();
         }
         setTimeout(function() { launchSearch()}, 250);
     }

     function search() {
      $.ajax({
                    type : 'POST',
                    data : filter,
                    url : '/search_publishings',
                    success : function(data) {
                        //console.log(data);
                        console.table(JSON.parse(data));
                        $("tbody.list-publishings").html(changeTable(JSON.parse(data)));
                    }
      });
     }

     function changeTable(data) {
        html = ''
        if (data.length == 0) {
            html = "<b>Nothing found !</b>"
        }
        else {
            data.forEach(function(row) {
                html += '<tr>'
                html += '<td>' + row['channel'] + '</td>'
                html += '<td>' + row['subject'] + '</td>'
                html += '<td><div class="row"><div class="col">'+row['body']+'</div></div></td>'
                html += '<td>' + row['author'] + '</td>'
                html += '<td><a href="'+row['button']+'" class="btn btn-outline-primary" role="button">Moderate</a></td>'
                html += '</tr>'
            });
        }
        return html
     }

     function removeFromArray(tb, value) {
        var tb2 = new Array();
        tb.forEach(function(item, index) {
            if (item != value)
                tb2.push(item);
        });
        return tb2;
    }
    function isInArray(tb, value) {
        var isIn = false;
        tb.forEach(function(item, index) {
            if (item.localeCompare(value) == 0)
                isIn = true;
        });
        return isIn;
    }

     launchSearch();
     waitJQuery(launchListener);
</script>