{% extends "layout.html" %}
{% block title %}New Post{% endblock %}
{% block content %}
    <h1>New Post</h1>
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#home">General</a>
      </li>
      {% for chan in l_chan %}
          <li class="nav-item" id="li_{{ chan.name }}" style="display:none;">
            <a class="nav-link" data-toggle="tab" href="#menu{{ chan.id }}">{{ chan.name }}</a>
          </li>
     {% endfor %}
    </ul>
    {% if session.logged_in %}
        <p>{{ user }}</p>
        <form method="POST" action="">
            <div class="tab-content">
              <div class="tab-pane container-fluid active" id="home">

                <div class="row">
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="titlepost">Title</label><br>
                                    <input type="text" name="titlepost" id="titlepost" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="descriptionpost">Description</label><br>
                                    <textarea class="form-control" rows="5" id="descriptionpost" name="descriptionpost"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="linkurlpost">Link</label><br>
                                    <input type="text" name="linkurlpost" id="linkurlpost" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="imagepost">Image</label><br>
                                    <input type="file" name="imagepost" id="imagepost" class="form-control">
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="datefrompost">Publication Date</label><br>
                                            <input id="datefrompost" name="datefrompost" type="date" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="dateuntilpost">Publication Until</label><br>
                                            <input id="dateuntilpost" name="dateuntilpost" type="date" class="form-control">
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="form-group">
                             <label for="publishpost">Publish</label>
                             {% if l_chan|length == 0 %}
                                 <p>No channel available for this user</p>
                             {% else %}
                                 {% for chan in l_chan %}
                                     <div class="form-check">
                                      <label class="form-check-label">
                                        <input id="chan_option_{{ chan.id }}" data-namechan="{{ chan.name }}" data-unavailablefields="{{ chan.unavailablefields }}" name="chan_option_{{ chan.id }}" type="checkbox" class="form-check-input checkbox" value="{{ chan.id }}">{{ chan.name }}
                                      </label>
                                    </div>
                                 {% endfor %}
                             {% endif %}
                         </div>

                         <div class="card">
                          <div class="card-header">Status</div>

                          <div class="card-body">Content</div>
                            <a class="btn btn-primary" onclick="loginWithPermissions()">Login Custom</a>
                            <a href=# id=fbcred class="btn btn-primary" title="You need to click this button in order to get your page(s) access tokens from facebook">Request Permissions</a>

                         </div>


                    </div>

                </div>

              </div>
              {% for chan in l_chan %}
                  <div class="tab-pane container-fluid fade" id="menu{{ chan.id }}">

                    <div class="row">
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ chan.name }}_titlepost">Title</label><br>
                                    <input type="text" name="{{ chan.name }}_titlepost" id="{{ chan.name }}_titlepost" class="form-control">
                                </div>
                                <div class="fb-login-button" data-max-rows="1" data-size="large" data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="true" data-use-continue-as="true"></div>
                                <div class="form-group">
                                    <label for="{{ chan.name }}_descriptionpost">Description</label><br>
                                    <textarea class="form-control" rows="5" id="{{ chan.name }}_descriptionpost" name="{{ chan.name }}_descriptionpost"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="{{ chan.name }}_linkurlpost">Link</label><br>
                                    <input type="text" name="{{ chan.name }}_linkurlpost" id="{{ chan.name }}_linkurlpost" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="{{ chan.name }}_imagepost">Image</label><br>
                                    <input type="file" name="{{ chan.name }}_imagepost" id="{{ chan.name }}_imagepost" class="form-control">
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ chan.name }}_datefrompost">Publication Date</label><br>
                                            <input id="{{ chan.name }}_datefrompost" name="{{ chan.name }}_datefrompost" type="date" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ chan.name }}_dateuntilpost">Publication Until</label><br>
                                            <input id="{{ chan.name }}_dateuntilpost" name="{{ chan.name }}_dateuntilpost" type="date" class="form-control">
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="form-group">
                             <label for="publishpost">Publish</label>
                             <div>
                              <label class="form-check-label">
                               {{ chan.name }}

                             </div>

                         </div>

                         <div class="card">
                          <div class="card-header">Status</div>

                          <div class="card-body">Content</div>
                         </div>


                    </div>
                </div>


                  </div>
              {% endfor %}
            </div>
            <div align="right" style="margin-top: 1rem; ">
               <button class="btn btn-primary" formaction="{{ url_for('posts.new_post')}}" formmethod="post" type="submit">Save as draft</button>
               <button id="publish-button" class="btn btn-success" formaction="{{ url_for('posts.publish_from_new_post')}}" formmethod="post" type="submit" disabled>Save & Publish</button>
               <button class="btn btn-outline-primary" type="reset">Abort</button>
            </div>

        </form>
    {% else %}
        Your are not logged in.
    {% endif %}
        

{% endblock %}

{% block scripts %}

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>


<script>
            
    // This is called with the results from from FB.getLoginStatus().
    function statusChangeCallback(response) {
        console.log('statusChangeCallback');
        console.log(response);
        // The response object is returned with a status field that lets the
        // app know the current login status of the person.
        // Full docs on the response object can be found in the documentation
        // for FB.getLoginStatus().
        if (response.status === 'connected') {
        // Logged into your app and Facebook.
        testAPI();
        } else {
            console.log('passe dans le else')
        // The person is not logged into your app or we are unable to tell.
        document.getElementById('status').innerHTML = 'Please log ' +
            'into this app.';
        }
        //loginWithPermissions();

    }
    
    // This function is called when someone finishes with the Login
    // Button.  See the onlogin handler attached to it in the sample
    // code below.
    function checkLoginState() {
        FB.getLoginStatus(function(response) {
            statusChangeCallback(response);
        }
        
        );
    }
    
    window.fbAsyncInit = function() {
        FB.init({
        appId      : '523437948128033',
        cookie     : true,  // enable cookies to allow the server to access 
        xfbml      : true,  // parse social plugins on this page
        version    : 'v3.2' // use graph api version 2.8
        });

        // Now that we've initialized the JavaScript SDK, we call 
        // FB.getLoginStatus().  This function gets the state of the
        // person visiting this page and can return one of three states to
        // the callback you provide.  They can be:
        //
        // 1. Logged into your app ('connected')
        // 2. Logged into Facebook, but not your app ('not_authorized')
        // 3. Not logged into Facebook and can't tell if they are logged into
        //    your app or not.
        //
        // These three cases are handled in the callback function.

        /*FB.getLoginStatus(function(response) {
            statusChangeCallback(response);
        });
        */
        

    };

    // Load the SDK asynchronously
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    // Here we run a very simple test of the Graph API after login is
    // successful.  See statusChangeCallback() for when this call is made.
    function testAPI() {
        console.log('Welcome!  Fetching your information.... ');
        FB.api('/me', function(response) {
        console.log('Successful login for: ' + response.name);
        document.getElementById('status').innerHTML =
            'Thanks for logging in, ' + response.name + '!';
            
        });
        
    }
    function loginWithPermissions(){
        FB.login(function(response) {
            console.log("in loginWithPermissions()");
            console.log(response);
        }, {
            scope: 'email, manage_pages, pages_show_list, publish_pages, business_management, publish_to_groups, public_profile', 
            return_scopes: true
        });
        FB.getLoginStatus (function (response) {
            if(response.status === 'connected'){
                console.log("DAAAANS GET LOOOOGIIIIN")

                console.log (response);
            }
        });
    }
    function requestPermissionsForPage(callback){
        FB.api (
            "/me/accounts",
            function (response) {
                console.log("DEVANT LE IIIIIIFFFF")
                console.log(response);
                
                if(response && !response.error){
                    console.log("DAAAANS APIIIIII")
                    console.log (response);
                    callback(response);
                }
                
                
                
            }
        ), {Scope: "manage_pages"};
    }


</script>

<script type=text/javascript>
    
    var credentials = "";
    $('a#fbcred').click(function(){
                requestPermissionsForPage(function(res){
                    credentials = res;
                    console.log("credentials are : ");
                    console.log(credentials)
                    $.ajax({
                        type: "POST",
                        contentType:"application/json;charset=utf-8",
                        url:"/facebook_credentials",
                        data: JSON.stringify({credentials}),
                        dataType: "json",
                    });
                     
                });    
        });
            
</script>
    
    


    <script>
        
        // This manage if a channel is selected or not:
        //  it hides/shows a tab for a channel
        //  it adds an information bullet to unavailable fields for each channel
        $('input.checkbox').change(function () {
            var nbselected = $('input.checkbox:checked').length;
            if(nbselected ==0){
               $("#publish-button").prop('disabled', true);
            }else{
               $("#publish-button").prop('disabled', false);
            }

            nameC=$(this).attr('data-namechan');
            fields = $(this).attr('data-unavailablefields');
            split = fields.split(',');
            if ($(this).is(':checked')) {
                //If the channel is selected
                $(this).addClass('checked');
                for(var i = 0; i < split.length; i++) {
                    $("input[id='"+nameC+"_"+ $('#'+split[i].toLowerCase()+'post').attr('id') + "']").prop('disabled', true);
                    $("textarea[id='"+nameC+"_"+ $('#'+split[i].toLowerCase()+'post').attr('id') + "']").prop('disabled', true);

                    $("label[for='"+nameC+"_"+ $('#'+split[i].toLowerCase()+'post').attr('id') + "']").append('<a href="#" data-toggle="popover" title="Unavailable field" data-content="This field is unavailable for channel ' + nameC +'"><i class="fas fa-exclamation-circle" style="color:orange"></i></a>');

                }
                $('[data-toggle="popover"]').popover();
                $('#li_'+nameC).show();
            } else {
                //If the channel is not selected
                $(this).removeClass('checked');
                for(var i = 0; i < split.length; i++) {
                    $("input[id='"+nameC+"_"+ $('#'+split[i].toLowerCase()+'post').attr('id') + "']").prop('disabled', false);
                    $("textarea[id='"+nameC+"_"+ $('#'+split[i].toLowerCase()+'post').attr('id') + "']").prop('disabled', false);
                    $("label[for='"+nameC+"_"+ $('#'+split[i].toLowerCase()+'post').attr('id') + "'] > a").remove();
                }
                $('#li_'+nameC).hide();
            }
        });
        // From here, I copy a field ONCE from general to all the equivalent fields of each channel
        //It works but it's not really sexy to rewrite this for all fields of general tab
        $('#titlepost').one("change",function(event){
            text = ($(this).val());
            //This is a subselect of input that match with the regex .*titlepost
            $('input')
                .filter(function() {
                    return this.id.match(/.*titlepost/);
                })
                .val(text);
        });
        $('#descriptionpost').one("change",function(event){
            text = ($(this).val());
            //This is a subselect of input that match with the regex .*descriptionpost
            $('textarea')
                .filter(function() {
                    return this.id.match(/.*descriptionpost/);
                })
                .val(text);
        });
        $('#linkurlpost').one("change",function(event){
            text = ($(this).val());
            //This is a subselect of input that match with the regex .*linkurlpost
            $('input')
                .filter(function() {
                    return this.id.match(/.*linkurlpost/);
                })
                .val(text);
        });
        $('#imagepost').one("change",function(event){
            text = ($(this).val());
            //This is a subselect of input that match with the regex .*imagepost
            $('input')
                .filter(function() {
                    return this.id.match(/.*imagepost/);
                })
                .val(text);
        });
        $('#dateuntilpost').one("change",function(event){
            text = ($(this).val());
            //This is a subselect of input that match with the regex .*dateuntilpost
            $('input')
                .filter(function() {
                    return this.id.match(/.*dateuntilpost/);
                })
                .val(text);
        });
        $('#datefrompost').one("change",function(event){
            text = ($(this).val());
            //This is a subselect of input that match with the regex .*datefrompost
            $('input')
                .filter(function() {
                    return this.id.match(/.*datefrompost/);
                })
                .val(text);
        });



    </script>

{% endblock %}